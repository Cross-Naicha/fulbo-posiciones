<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Tabla de Posiciones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b0d10; --card:#11161c; --ink:#e8eef6; --muted:#9fb0c3; --line:#223042; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--ink); }
    .wrap { max-width: 1080px; margin: 32px auto; padding: 0 16px; }
    h1 { text-align:center; margin: 0 0 8px; }
    .sub { text-align:center; color:var(--muted); margin-bottom:16px; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:16px; overflow:hidden; box-shadow:0 8px 24px rgba(0,0,0,.25); }
    table { width:100%; border-collapse: collapse; }
    thead th {
      text-transform:uppercase; font-size:12px; letter-spacing:.6px;
      background:linear-gradient(180deg, #162233, #141a23);
      color:var(--muted); border-bottom:1px solid var(--line); padding:12px 10px; text-align:center;
      position: sticky; top: 0; z-index: 1;
    }
    tbody td { padding:12px 10px; border-bottom:1px solid var(--line); text-align:center; }
    tbody tr:nth-child(even) { background:#0f141c; }
    .right { text-align:right; }
    .status { text-align:center; color:var(--muted); padding:10px; }
    @media (max-width: 640px) { table { font-size: 14px; } thead th, tbody td { padding:10px 8px; } }

    /* --- links como texto plano --- */
    a, a:visited, a:hover, a:active, a:focus { color: inherit; text-decoration: none; }

    /* ===== separador y tarjetas de partidos ===== */
    .sep { height:1px; background:var(--line); margin:28px 0; border-radius:1px; }
    h2 { margin:0 0 8px; font-size:20px; text-align:center; }
    .sub2 { text-align:center; color:var(--muted); margin-bottom:16px; font-size:14px; }

    .matches-card { padding:12px; }
    .matches-status { text-align:center; color:var(--muted); padding:8px 10px; }
    .matches-grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap:12px;
      padding:8px;
    }
    .match {
      border:1px solid var(--line);
      border-radius:12px;
      padding:12px;
      background: linear-gradient(180deg, #10151c, #0f141b);
    }
    .match-head {
      font-size:12px; color:var(--muted);
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:8px;
    }
    .match-body {
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      gap:8px;
    }
    .team {
      font-size:13px; line-height:1.25;
      color:var(--ink);
      opacity:.95;
    }
    .team.right {
      text-align: right;
    }
    .score {
      font-size:28px; font-weight:700; letter-spacing:.5px;
      padding:4px 8px; border-radius:8px; border:1px solid var(--line);
      text-align:center; min-width:84px;
    }
    @media (max-width: 480px){
      .score { font-size:24px; min-width:72px; }
      .team  { font-size:12px; }
    }
    /* ===== fin partidos ===== */

    /* ===== Rachas (positivas / negativas) ===== */
    :root { --pos:#2fbf71; --neg:#ff6b6b; }
    .streaks-card { padding:12px; }
    .streaks-status { text-align:center; color:var(--muted); padding:8px 10px; }
    .streaks-grid {
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap:12px; padding:8px;
    }
    .streak {
      border:1px solid var(--line);
      border-left-width:4px;
      border-radius:12px;
      padding:12px;
      background: linear-gradient(180deg, #10151c, #0f141b);
      display:grid; gap:6px;
    }
    .streak.pos { border-left-color: color-mix(in srgb, var(--pos) 70%, transparent); }
    .streak.neg { border-left-color: color-mix(in srgb, var(--neg) 70%, transparent); }

    .streak-top {
      display:flex; align-items:center; justify-content:space-between;
      font-size:12px; color:var(--muted);
    }
    .badge {
      font-size:11px; text-transform:uppercase; letter-spacing:.5px;
      padding:3px 8px; border-radius:999px; border:1px solid var(--line);
      background:#0f141b90;
    }
    .badge.pos { border-color: color-mix(in srgb, var(--pos) 60%, var(--line)); }
    .badge.neg { border-color: color-mix(in srgb, var(--neg) 60%, var(--line)); }

    .streak-main { display:flex; align-items:baseline; gap:10px; }
    .streak-name { font-size:14px; font-weight:600; color:var(--ink); }
    .streak-len  {
      margin-left:auto; font-weight:700; font-size:18px;
      padding:2px 8px; border-radius:8px; border:1px solid var(--line);
    }
    .streak-dates { font-size:12px; color:var(--muted); }
    @media (max-width: 480px){ .streak-len{ font-size:16px; } }

  </style>
</head>
<body>
  <div class="wrap">
    <h1>PROMIEDOS (PMX)</h1>
    <div class="sub"> TORNEO DE TRANSICIÓN: CHIQUI NAICHA </code></div>
    <div class="sep"></div>

    <div class="card">
      <div id="status" class="status">Cargando datos…</div>
      <table id="tabla" style="display:none">
        <thead>
          <tr>
            <th>N°</th>
            <th>Nombre</th>
            <th>PJ</th>
            <th>Pts.</th>
            <th>%</th>
            <th>PMX</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <p> (*) Ultimo campeón.</p>

    <!-- ===== separador y sección Partidos ===== -->
    <div class="sep"></div>
    <h2>Partidos</h2>
    <div class="sep"></div>

    <!-- ===== Rachas ===== -->
    <div class="sub2">Rachas destacadas</div>
    <div class="card streaks-card">
      <div id="streaksStatus" class="streaks-status">Cargando rachas…</div>
      <div id="streaksGrid" class="streaks-grid" style="display:none"></div>
      <div id="streaksEmpty" class="streaks-status" style="display:none">No hay rachas para mostrar.</div>
    </div>
    <!-- ===== fin Rachas ===== -->

    <div class="sep"></div>
    <div class="sub2">Últimos Resultados</div>
    <div class="card matches-card">
      <div id="matchesStatus" class="matches-status">Cargando partidos…</div>
      <div id="matchesGrid" class="matches-grid" style="display:none"></div>
      <div id="matchesEmpty" class="matches-status" style="display:none">No hay partidos cargados todavía.</div>
    </div>
    <!-- ===== fin sección Partidos ===== -->
    <div class="sep"></div>
    <div class="sep"></div>
  </div>

  <script>
    const status = document.getElementById("status");
    const tabla  = document.getElementById("tabla");
    const tbody  = document.getElementById("tbody");

    function setStatus(msg){ status.textContent = msg; status.style.display='block'; tabla.style.display='none'; }
    function showTable(){ status.style.display='none'; tabla.style.display='table'; }

    function fmt3(v){ const n = Number(v); return Number.isFinite(n) ? n.toFixed(3) : v; }

    async function cargar(){
      try{
        setStatus("Cargando datos…");
        const bust = Date.now();
        const res = await fetch(`data/posiciones.json?v=${bust}`, { cache: "no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);
        const rows = await res.json();

        tbody.innerHTML = "";
        for(const r of rows){
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="right">${r.n ?? ""}</td>
            <td><a href="jugador.html?id=${r.id}">${r.jugador ?? ""}</a></td>
            <td class="right">${r.partidos ?? ""}</td>
            <td class="right">${r.puntos ?? ""}</td>
            <td class="right">${fmt3(r.efectividad ?? "")}</td>
            <td>${r.promedio ?? ""}</td>
          `;
          tbody.appendChild(tr);
        }
        showTable();
      }catch(err){
        setStatus("Error al cargar datos: " + err.message);
        console.error(err);
      }
    }
    cargar();

    /* ===================== Partidos como tarjetas (sin badges ni resaltados) ===================== */

    const matchesStatus = document.getElementById('matchesStatus');
    const matchesGrid   = document.getElementById('matchesGrid');
    const matchesEmpty  = document.getElementById('matchesEmpty');

    const fmtFecha = (iso) => {
      // Espera YYYY-MM-DD; muestra en es-AR tipo "mié 03 sep 2025"
      try{
        const [y,m,d] = iso.split('-').map(Number);
        const dt = new Date(Date.UTC(y, (m-1), d, 12)); // 12:00 UTC para evitar edge cases de TZ
        return new Intl.DateTimeFormat('es-AR', { weekday:'short', day:'2-digit', month:'short', year:'numeric' })
          .format(dt).replaceAll('.', '');
      }catch{ return iso; }
    };

    function parseLinea(linea){
      // "Equipo A | 12 VS. 11 | Equipo B"
      const partes = linea.split('|').map(s => s.trim());
      if(partes.length !== 3) return { raw: linea, ok:false };
      const [equipoA, marcador, equipoB] = partes;
      const m = marcador.match(/(\d+)\s*VS\.\s*(\d+)/i);
      if(!m) return { raw: linea, equipoA, equipoB, marcadorRaw: marcador, ok:false };
      const golesA = Number(m[1]), golesB = Number(m[2]);
      return { equipoA, equipoB, golesA, golesB, ok:true };
    }

    function teamBlock(text, align = 'left'){
      const div = document.createElement('div');
      div.className = 'team';
      if (align === 'right') div.classList.add('right');
      div.textContent = text;
      if (/\*/.test(text)) div.title = 'Último campeón';
      return div;
}


    function scoreBlock(a, b){
      const s = document.createElement('div');
      s.className = 'score';
      s.setAttribute('aria-label', `${a} a ${b}`);
      s.textContent = `${a} - ${b}`;
      return s;
    }

    /* ===== Rachas ===== */
    const streaksStatus = document.getElementById('streaksStatus');
    const streaksGrid   = document.getElementById('streaksGrid');
    const streaksEmpty  = document.getElementById('streaksEmpty');

    function fmtFechaCorta(iso){
      try{
        const [y,m,d] = iso.split('-').map(Number);
        const dt = new Date(Date.UTC(y,(m-1),d,12));
        return new Intl.DateTimeFormat('es-AR', { day:'2-digit', month:'short', year:'numeric' })
          .format(dt).replaceAll('.', '');
      }catch{ return iso; }
    }

    function streakCard(item){
      const el = document.createElement('article');
      const isPos = (item.racha || '').toLowerCase().startsWith('pos');
      el.className = `streak ${isPos ? 'pos':'neg'}`;

      const top = document.createElement('div');
      top.className = 'streak-top';
      const badge = document.createElement('span');
      badge.className = `badge ${isPos ? 'pos':'neg'}`;
      badge.textContent = item.racha || '';
      top.appendChild(badge);

      const main = document.createElement('div');
      main.className = 'streak-main';
      const name = document.createElement('div');
      name.className = 'streak-name';
      name.textContent = item.jugador || '';
      const len = document.createElement('div');
      len.className = 'streak-len';
      len.textContent = `x${item.extension ?? 0}`;
      main.append(name, len);

      const dates = document.createElement('div');
      dates.className = 'streak-dates';
      dates.textContent = `Desde ${fmtFechaCorta(item.inicio)}`;

      el.append(top, main, dates);
      return el;
    }

    async function cargarRachas(){
      streaksStatus.style.display = 'block';
      streaksGrid.style.display   = 'none';
      streaksEmpty.style.display  = 'none';
      try{
        const bust = Date.now();
        const res = await fetch(`data/rachas.json?v=${bust}`, { cache:'no-store' });
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        const arr = Array.isArray(data) ? data : [];

        if(arr.length === 0){
          streaksStatus.style.display = 'none';
          streaksEmpty.style.display  = 'block';
          return;
        }

        // orden sugerido: positivas primero, luego negativas; dentro de cada una por extensión desc
        arr.sort((a,b)=>{
          const ra = (a.racha||'').toLowerCase().startsWith('pos') ? 0 : 1;
          const rb = (b.racha||'').toLowerCase().startsWith('pos') ? 0 : 1;
          if(ra !== rb) return ra - rb;
          return (b.extension||0) - (a.extension||0);
        });

        streaksGrid.innerHTML = '';
        for(const s of arr) streaksGrid.appendChild(streakCard(s));

        streaksStatus.style.display = 'none';
        streaksGrid.style.display   = 'grid';
      }catch(err){
        console.error(err);
        streaksStatus.textContent = 'Error al cargar rachas: ' + err.message;
      }
    }
    /* ===== fin Rachas ===== */

    // ya llamás cargar() arriba; ahora llamá también:
    cargarRachas();
    // y luego el resto:
    cargarPartidos();

    async function cargarPartidos(){
      matchesStatus.style.display = 'block';
      matchesGrid.style.display   = 'none';
      matchesEmpty.style.display  = 'none';

      try{
        const bust = Date.now();
        const res  = await fetch(`data/partidos.json?v=${bust}`, { cache:'no-store' });
        if(!res.ok) throw new Error("HTTP " + res.status);
        const obj  = await res.json();

        const entries = Object.entries(obj)
          .filter(([fecha, linea]) => typeof linea === 'string' && fecha)
          .sort(([f1],[f2]) => f2.localeCompare(f1)); // más reciente primero (YYYY-MM-DD)

        matchesGrid.innerHTML = '';

        if(entries.length === 0){
          matchesStatus.style.display = 'none';
          matchesEmpty.style.display  = 'block';
          return;
        }

        for(const [fecha, linea] of entries){
          const parsed = parseLinea(linea);
          const card   = document.createElement('article');
          card.className = 'match';
          card.setAttribute('role','group');
          card.setAttribute('aria-labelledby', `m-${fecha}`);

          // header
          const head = document.createElement('div');
          head.className = 'match-head';
          const hleft = document.createElement('div');
          hleft.id = `m-${fecha}`;
          hleft.textContent = fmtFecha(fecha);
          head.appendChild(hleft);

          // cuerpo
          const body = document.createElement('div');
          body.className = 'match-body';

          if(parsed.ok){
            const left  = teamBlock(parsed.equipoA, 'left');
            const score = scoreBlock(parsed.golesA, parsed.golesB);
            const right = teamBlock(parsed.equipoB, 'right');
            body.append(left, score, right);
          } else {
            // fallback: mostramos crudo si no matchea el formato
            const raw = document.createElement('div');
            raw.className = 'team';
            raw.textContent = linea;
            body.style.gridTemplateColumns = '1fr';
            body.appendChild(raw);
          }

          card.prepend(head);
          card.appendChild(body);
          matchesGrid.appendChild(card);
        }

        matchesStatus.style.display = 'none';
        matchesGrid.style.display   = 'grid';
      }catch(err){
        console.error(err);
        matchesStatus.textContent = 'Error al cargar partidos: ' + err.message;
      }
    }

    cargarPartidos();
    /* =================== FIN Partidos =================== */
  </script>
</body>
</html>
